<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Operator Composition · EarthSciMLBase.jl</title><meta name="title" content="Operator Composition · EarthSciMLBase.jl"/><meta property="og:title" content="Operator Composition · EarthSciMLBase.jl"/><meta property="twitter:title" content="Operator Composition · EarthSciMLBase.jl"/><meta name="description" content="Documentation for EarthSciMLBase.jl."/><meta property="og:description" content="Documentation for EarthSciMLBase.jl."/><meta property="twitter:description" content="Documentation for EarthSciMLBase.jl."/><meta property="og:url" content="https://EarthSciML.github.io/EarthSciMLBase.jl/operator_compose/"/><meta property="twitter:url" content="https://EarthSciML.github.io/EarthSciMLBase.jl/operator_compose/"/><link rel="canonical" href="https://EarthSciML.github.io/EarthSciMLBase.jl/operator_compose/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">EarthSciMLBase.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../composition/">Composition</a></li><li class="is-active"><a class="tocitem" href>Operator Composition</a><ul class="internal"><li><a class="tocitem" href="#Examples"><span>Examples</span></a></li></ul></li><li><a class="tocitem" href="../param_to_var/">Parameter Replacement</a></li><li><a class="tocitem" href="../icbc/">Initial and Boundary Conditions</a></li><li><a class="tocitem" href="../advection/">Advection</a></li><li><a class="tocitem" href="../coord_transforms/">Coordinate Transforms</a></li><li><a class="tocitem" href="../operator/">Operators</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../example_all_together/">All Together</a></li></ul></li><li><a class="tocitem" href="../api/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Operator Composition</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Operator Composition</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EarthSciML/EarthSciMLBase.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EarthSciML/EarthSciMLBase.jl/blob/main/docs/src/operator_compose.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Operator-Composition"><a class="docs-heading-anchor" href="#Operator-Composition">Operator Composition</a><a id="Operator-Composition-1"></a><a class="docs-heading-anchor-permalink" href="#Operator-Composition" title="Permalink"></a></h1><p>There are a lot of cases where there are two different &quot;processes&quot; or &quot;operators&quot; that change the same variable.  For example, CO2 in the atmosphere can be emitted by human activity, and it can also be absorbed by the ocean. In models, typically the emission and removal are considered separate processes which are represented by separate model components. However, when we want to combine these two components into a single model, we need to be able to compose them together.</p><p>We can use the <a href="../api/#EarthSciMLBase.operator_compose"><code>operator_compose</code></a> function for this. It composes to systems of equations together by adding the right-hand side terms together of equations that have matching left-hand sides. The left hand sides of two equations will be considered matching if:</p><ol><li>They are both time derivatives of the same variable.</li><li>The first one is a time derivative of a variable and the second one is the variable itself.</li><li>There is an entry in the optional <code>translate</code> dictionary or array that maps the dependent variable in the first system to the dependent variable in the second system, e.g. <code>[sys1.sys.x =&gt; sys2.sys.y]</code>.</li><li>There is an entry in the optional <code>translate</code> dictionary or array that maps the dependent variable in the first system to the dependent variable in the second system, with a conversion factor, e.g. <code>[sys1.sys.x =&gt; sys2.sys.y =&gt; 6]</code>.</li></ol><p>Perhaps we can make this somewhat clearer with some examples.</p><h2 id="Examples"><a class="docs-heading-anchor" href="#Examples">Examples</a><a id="Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Examples" title="Permalink"></a></h2><h3 id="Example-with-matching-variable-time-derivatives"><a class="docs-heading-anchor" href="#Example-with-matching-variable-time-derivatives">Example with matching variable time derivatives</a><a id="Example-with-matching-variable-time-derivatives-1"></a><a class="docs-heading-anchor-permalink" href="#Example-with-matching-variable-time-derivatives" title="Permalink"></a></h3><p>The example below shows that when we <code>operator_compose</code> two systems together that are both equal to <code>D(x) = p</code>, the resulting system is equal to <code>D(x) = 2p</code>.</p><pre><code class="language-julia hljs">using EarthSciMLBase
using ModelingToolkit
using ModelingToolkit: t_nounits, D_nounits
t = t_nounits
D = D_nounits


struct ExampleSysCoupler sys end
function ExampleSys()
    @variables x(t)
    @parameters p
    ODESystem([D(x) ~ p], t; name=:ExampleSys,
        metadata=Dict(:coupletype=&gt;ExampleSysCoupler))
end

ExampleSys()</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} x\left( t \right)}{\mathrm{d}t} &amp;= p
\end{align}
 \]</p><pre><code class="language-julia hljs">struct ExampleSys2Coupler sys end
function ExampleSys2()
    @variables x(t)
    @parameters p
    ODESystem([D(x) ~ 2p], t; name=:ExampleSys2,
        metadata=Dict(:coupletype=&gt;ExampleSys2Coupler))
end

ExampleSys2()</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} x\left( t \right)}{\mathrm{d}t} &amp;= 2 p
\end{align}
 \]</p><pre><code class="language-julia hljs">sys1 = ExampleSys()
sys2 = ExampleSys2()

function EarthSciMLBase.couple2(sys1::ExampleSysCoupler, sys2::ExampleSys2Coupler)
    sys1, sys2 = sys1.sys, sys2.sys
    operator_compose(sys1, sys2)
end

combined = couple(sys1, sys2)

combined_mtk = convert(ODESystem, combined)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} \mathtt{ExampleSys.x}\left( t \right)}{\mathrm{d}t} &amp;= \mathtt{ExampleSys.p} + \mathtt{ExampleSys.ExampleSys2\_ddt\_xˍt}\left( t \right)
\end{align}
 \]</p><p>The simplified equation should be D(x) = p + sys2_xˍt:</p><p>where sys2_xˍt is also equal to p:</p><pre><code class="language-julia hljs">observed(combined_mtk)</code></pre><p class="math-container">\[ \begin{align}
\mathtt{ExampleSys2.ExampleSys2\_ddt\_xˍt}\left( t \right) &amp;= 2 \mathtt{ExampleSys2.p} \\
\mathtt{ExampleSys2.x}\left( t \right) &amp;= \mathtt{ExampleSys.x}\left( t \right) \\
\mathtt{ExampleSys.ExampleSys2\_ddt\_xˍt}\left( t \right) &amp;= \mathtt{ExampleSys2.ExampleSys2\_ddt\_xˍt}\left( t \right)
\end{align}
 \]</p><h3 id="Example-with-non-matching-variables"><a class="docs-heading-anchor" href="#Example-with-non-matching-variables">Example with non-matching variables</a><a id="Example-with-non-matching-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Example-with-non-matching-variables" title="Permalink"></a></h3><p>This example demonstrates a case where one variable in the first system is equal to another variable in the second system:</p><pre><code class="language-julia hljs">struct ExampleSys3Coupler sys end
function ExampleSys3()
    @variables y(t)
    @parameters p
    ODESystem([D(y) ~ p], t; name=:ExampleSys3,
        metadata=Dict(:coupletype=&gt;ExampleSys3Coupler))
end

sys1 = ExampleSys()
sys2 = ExampleSys3()

function EarthSciMLBase.couple2(sys1::ExampleSysCoupler, sys2::ExampleSys3Coupler)
    sys1, sys2 = sys1.sys, sys2.sys
    operator_compose(sys1, sys2, [sys1.x =&gt; sys2.y])
end

combined = couple(sys1, sys2)
combined_simplified = convert(ODESystem, combined)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} \mathtt{ExampleSys.x}\left( t \right)}{\mathrm{d}t} &amp;= \mathtt{ExampleSys.p} + \mathtt{ExampleSys.ExampleSys3\_ddt\_yˍt}\left( t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">observed(combined_simplified)</code></pre><p class="math-container">\[ \begin{align}
\mathtt{ExampleSys3.ExampleSys3\_ddt\_yˍt}\left( t \right) &amp;= \mathtt{ExampleSys3.p} \\
\mathtt{ExampleSys3.y}\left( t \right) &amp;= \mathtt{ExampleSys.x}\left( t \right) \\
\mathtt{ExampleSys.ExampleSys3\_ddt\_yˍt}\left( t \right) &amp;= \mathtt{ExampleSys3.ExampleSys3\_ddt\_yˍt}\left( t \right)
\end{align}
 \]</p><h3 id="Example-with-a-non-ODE-system"><a class="docs-heading-anchor" href="#Example-with-a-non-ODE-system">Example with a non-ODE system</a><a id="Example-with-a-non-ODE-system-1"></a><a class="docs-heading-anchor-permalink" href="#Example-with-a-non-ODE-system" title="Permalink"></a></h3><p>In the second case above, we might have a variable in the second system that is equal to a rate, but it is not a time derivative. This could happen if we are extracting emissions from a file, and those emissions are already in units of kg/s, or something similar. The example below demonstrates this case.  (Note that this case can also be used with the conversion factors shown in the last example.)</p><pre><code class="language-julia hljs">struct ExampleSysNonODECoupler sys end
function ExampleSysNonODE()
    @variables y(t)
    @parameters p
    ODESystem([y ~ p], t; name=:ExampleSysNonODE,
        metadata=Dict(:coupletype=&gt;ExampleSysNonODECoupler))
end

sys1 = ExampleSys()
sys2 = ExampleSysNonODE()

function EarthSciMLBase.couple2(sys1::ExampleSysCoupler, sys2::ExampleSysNonODECoupler)
    sys1, sys2 = sys1.sys, sys2.sys
    operator_compose(sys1, sys2, [sys1.x =&gt; sys2.y])
end

combined = couple(sys1, sys2)
sys_combined = convert(ODESystem, combined)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} \mathtt{ExampleSys.x}\left( t \right)}{\mathrm{d}t} &amp;= \mathtt{ExampleSys.p} + \mathtt{ExampleSys.ExampleSysNonODE\_y}\left( t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">observed(sys_combined)</code></pre><p class="math-container">\[ \begin{align}
\mathtt{ExampleSysNonODE.y}\left( t \right) &amp;= \mathtt{ExampleSysNonODE.p} \\
\mathtt{ExampleSys.ExampleSysNonODE\_y}\left( t \right) &amp;= \mathtt{ExampleSysNonODE.y}\left( t \right)
\end{align}
 \]</p><h3 id="Example-with-non-matching-variables-and-a-conversion-factor"><a class="docs-heading-anchor" href="#Example-with-non-matching-variables-and-a-conversion-factor">Example with non-matching variables and a conversion factor</a><a id="Example-with-non-matching-variables-and-a-conversion-factor-1"></a><a class="docs-heading-anchor-permalink" href="#Example-with-non-matching-variables-and-a-conversion-factor" title="Permalink"></a></h3><p>Finally, this last example shows the fourth case, where a conversion factor is included in the translation dictionary or array.</p><pre><code class="language-julia hljs">struct ExampleSysNonODE2Coupler sys end
function ExampleSysNonODE2()
    @variables y(t)
    @parameters p
    ODESystem([y ~ p], t; name=:Docs₊ExampleSysNonODE2,
        metadata=Dict(:coupletype=&gt;ExampleSysNonODE2Coupler))
end

sys1 = ExampleSys()
sys2 = ExampleSysNonODE2()

function EarthSciMLBase.couple2(sys1::ExampleSysCoupler, sys2::ExampleSysNonODE2Coupler)
    sys1, sys2 = sys1.sys, sys2.sys
    operator_compose(sys1, sys2, [sys1.x =&gt; sys2.y =&gt; 6.0])
end

combined = couple(sys1, sys2)
combined_simplified = convert(ODESystem, combined)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} \mathtt{ExampleSys.x}\left( t \right)}{\mathrm{d}t} &amp;= \mathtt{ExampleSys.p} + \mathtt{ExampleSys.Docs.ExampleSysNonODE2\_y}\left( t \right)
\end{align}
 \]</p><pre><code class="language-julia hljs">observed(combined_simplified)</code></pre><p class="math-container">\[ \begin{align}
\mathtt{Docs.ExampleSysNonODE2.y}\left( t \right) &amp;= \mathtt{Docs.ExampleSysNonODE2.p} \\
\mathtt{ExampleSys.Docs.ExampleSysNonODE2\_y}\left( t \right) &amp;= 6 \mathtt{Docs.ExampleSysNonODE2.y}\left( t \right)
\end{align}
 \]</p><p>!warning     The <code>operator_compose</code> function will not work correctly if any of the variables to be      composed are part of a <code>NonlinearSystem</code> rather than an <code>ODESystem</code>. The reason for this     is because <code>operator_compose</code> works by matching the left-hand sides of the equations in     the two systems, but <code>NonlinearSystem</code>s move all of the terms to the right-hand side of     the equation when they are created.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../composition/">« Composition</a><a class="docs-footer-nextpage" href="../param_to_var/">Parameter Replacement »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Wednesday 19 February 2025 01:40">Wednesday 19 February 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
